name: CI/CD to DigitalOcean

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  # TODO: Replace with your actual registry name
  REGISTRY: registry.digitalocean.com/qsi-africa
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Only login and push on 'push' events, not PRs (unless you want to push PR images)
      - name: Install doctl
        if: github.event_name == 'push'
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        if: github.event_name == 'push'
        run: doctl registry login --expiry-seconds 1200

      # ======================================================
      # SERVER
      # ======================================================
      - name: Build Server
        run: |
          docker build -t server-image ./server

      - name: Push Server to Registry
        if: github.event_name == 'push'
        run: |
          docker tag server-image $REGISTRY/server:$IMAGE_TAG
          docker tag server-image $REGISTRY/server:latest
          docker push $REGISTRY/server:$IMAGE_TAG
          docker push $REGISTRY/server:latest

      # ======================================================
      # CLIENT
      # ======================================================
      - name: Build Client
        run: |
          docker build \
            --build-arg VITE_API_BASE_URL=${{ vars.VITE_API_BASE_URL || 'https://api.qsi.africa/api' }} \
            -t client-image ./client

      - name: Push Client to Registry
        if: github.event_name == 'push'
        run: |
          docker tag client-image $REGISTRY/client:$IMAGE_TAG
          docker tag client-image $REGISTRY/client:latest
          docker push $REGISTRY/client:$IMAGE_TAG
          docker push $REGISTRY/client:latest

      # ======================================================
      # ADMIN CLIENT
      # ======================================================
      - name: Build Admin Client
        run: |
          docker build -t admin-client-image ./admin-client

      - name: Push Admin Client to Registry
        if: github.event_name == 'push'
        run: |
          docker tag admin-client-image $REGISTRY/admin-client:$IMAGE_TAG
          docker tag admin-client-image $REGISTRY/admin-client:latest
          docker push $REGISTRY/admin-client:$IMAGE_TAG
          docker push $REGISTRY/admin-client:latest

      # ======================================================
      # DEPLOY TO DROPLET
      # ======================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy docker-compose.yml to Droplet
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "./docker-compose.yml"
          target: "/root/app/"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Navigate to app directory
            cd /root/app

            # Login to Registry (using the token passed as env var or pre-configured)
            # You might need to install doctl on the droplet or just use docker login
            echo ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} | docker login registry.digitalocean.com -u ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} --password-stdin
            
            # Pull latest images
            docker compose pull
            
            # Restart services
            docker compose up -d


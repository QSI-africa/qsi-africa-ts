name: Deploy Monorepo to Droplet

on:
  push:
    branches:
      - main
      - master

env:
  # The user provided prompt uses this repo user
  DOCKER_REPO: qsidocker2026

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [server, client, admin-client]
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîë Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üèóÔ∏è Build & Push Images
        uses: docker/build-push-action@v6
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: ${{ env.DOCKER_REPO }}/qsi-${{ matrix.service }}:latest
          # Pass build args only for client service
          build-args: |
            ${{ matrix.service == 'client' && format('VITE_API_BASE_URL={0}', vars.VITE_API_BASE_URL || 'https://api.qsi.africa/api') || '' }}

  deploy-via-ssh:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: üöÄ Deploy to DigitalOcean Droplet
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Navigate to the project folder (or create it)
            mkdir -p ~/qsi-africa-ts && cd ~/qsi-africa-ts
            
            # Reset the folder to match your GitHub repo configuration (to get latest docker-compose.yml)
            # This requires 'git' to be installed on the droplet
            if [ -d ".git" ]; then
              git fetch origin main
              git reset --hard origin/main
            else
              git init
              git remote add origin https://github.com/${{ github.repository }}.git
              git fetch origin main
              git checkout -t origin/main
            fi

            # Login to Docker Hub on the server to avoid rate limits (optional but recommended)
            # echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            # Pull newest images
            docker compose pull
            
            # Restart containers
            docker compose up -d --remove-orphans
            
            # Clean up unused images to save disk space
            docker image prune -f
